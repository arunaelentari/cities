#!/bin/bash
#
# This script deploys cities program.
#
set -euo pipefail

echo "Salem, I will verify if we are in production"
if ! which sudo; then
  # TODO: ideally log errors to stderr
  echo "Oibui-oibaiai, we don't have sudo! Maybe you're in dev"
  exit 1
fi

echo "Bonjour, I will check if cities and cities.env exist"
if [[ ! -e cities ]] || [[ ! -e cities.env ]]; then
  echo "Oivey, cities or cities.env does not exist!!"
  exit 1
fi

echo "Stopping ye olde server"
sudo systemctl stop cities

echo "Whasaap! Copying files to target directory"
sudo cp cities cities.env /etc/cities/

echo "Hurray, restarting the server!"
sudo systemctl restart cities

source cities.env

./sendslack "Howdy ma'am, I redeployed the cities $CITIES_VERSION service"
